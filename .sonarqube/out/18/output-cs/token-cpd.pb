 
cC:\Users\SWDEV\Source\Repos\SW10.SWMANAGER\Tools\SW10.SWMANAGER.Migrator\SWMANAGERMigratorModule.cs
	namespace 	
SW10
 
. 
	SWMANAGER 
. 
Migrator !
{		 
[

 
	DependsOn

 
(

 
typeof

 
(

 
SWMANAGERDataModule

 )
)

) *
)

* +
]

+ ,
public 

class #
SWMANAGERMigratorModule (
:) *
	AbpModule+ 4
{ 
public 
override 
void 
PreInitialize *
(* +
)+ ,
{ 	
Database 
. 
SetInitializer #
<# $
SWMANAGERDbContext$ 6
>6 7
(7 8
null8 <
)< =
;= >
Configuration 
. 
BackgroundJobs (
.( )!
IsJobExecutionEnabled) >
=? @
falseA F
;F G
Configuration 
. 
ReplaceService (
(( )
typeof) /
(/ 0
	IEventBus0 9
)9 :
,: ;
(< =
)= >
=>? A
{ 

IocManager 
. 
IocContainer '
.' (
Register( 0
(0 1
	Component 
. 
For !
<! "
	IEventBus" +
>+ ,
(, -
)- .
.. /
Instance/ 7
(7 8
NullEventBus8 D
.D E
InstanceE M
)M N
) 
; 
} 
) 
; 
} 	
public 
override 
void 

Initialize '
(' (
)( )
{ 	

IocManager 
. (
RegisterAssemblyByConvention 3
(3 4
Assembly4 <
.< = 
GetExecutingAssembly= Q
(Q R
)R S
)S T
;T U
} 	
} 
}   ê

OC:\Users\SWDEV\Source\Repos\SW10.SWMANAGER\Tools\SW10.SWMANAGER.Migrator\Log.cs
	namespace 	
SW10
 
. 
	SWMANAGER 
. 
Migrator !
{ 
public 

class 
Log 
:  
ITransientDependency +
{		 
public

 
ILogger

 
Logger

 
{

 
get

  #
;

# $
set

% (
;

( )
}

* +
public 
Log 
( 
) 
{ 	
Logger 
= 

NullLogger 
.  
Instance  (
;( )
} 	
public 
void 
Write 
( 
string  
text! %
)% &
{ 	
Console 
. 
	WriteLine 
( 
Clock #
.# $
Now$ '
.' (
ToString( 0
(0 1
$str1 F
)F G
+H I
$strJ O
+P Q
textR V
)V W
;W X
Logger 
. 
Info 
( 
text 
) 
; 
} 	
} 
} øE
fC:\Users\SWDEV\Source\Repos\SW10.SWMANAGER\Tools\SW10.SWMANAGER.Migrator\MultiTenantMigrateExecuter.cs
	namespace 	
SW10
 
. 
	SWMANAGER 
. 
Migrator !
{ 
public 

class &
MultiTenantMigrateExecuter +
:, - 
ITransientDependency. B
{ 
public 
Log 
Log 
{ 
get 
; 
private %
set& )
;) *
}+ ,
private 
readonly 
IAbpZeroDbMigrator +
	_migrator, 5
;5 6
private 
readonly 
IRepository $
<$ %
Tenant% +
>+ ,
_tenantRepository- >
;> ?
private 
readonly 0
$IDbPerTenantConnectionStringResolver =%
_connectionStringResolver> W
;W X
public &
MultiTenantMigrateExecuter )
() *
IAbpZeroDbMigrator 
migrator '
,' (
IRepository 
< 
Tenant 
> 
tenantRepository  0
,0 1
Log 
log 
, 0
$IDbPerTenantConnectionStringResolver 0$
connectionStringResolver1 I
)I J
{ 	
Log 
= 
log 
; 
	_migrator 
= 
migrator  
;  !
_tenantRepository 
= 
tenantRepository  0
;0 1%
_connectionStringResolver   %
=  & '$
connectionStringResolver  ( @
;  @ A
}!! 	
public## 
void## 
Run## 
(## 
bool##  
skipConnVerification## 1
)##1 2
{$$ 	
var%% 
hostConnStr%% 
=%% %
_connectionStringResolver%% 7
.%%7 8%
GetNameOrConnectionString%%8 Q
(%%Q R
new%%R U'
ConnectionStringResolveArgs%%V q
(%%q r
MultiTenancySides	%%r É
.
%%É Ñ
Host
%%Ñ à
)
%%à â
)
%%â ä
;
%%ä ã
if&& 
(&& 
hostConnStr&& 
.&& 
IsNullOrWhiteSpace&& .
(&&. /
)&&/ 0
)&&0 1
{'' 
Log(( 
.(( 
Write(( 
((( 
$str(( a
)((a b
;((b c
return)) 
;)) 
}** 
Log,, 
.,, 
Write,, 
(,, 
$str,, '
+,,( )"
ConnectionStringHelper,,* @
.,,@ A
GetConnectionString,,A T
(,,T U
hostConnStr,,U `
),,` a
),,a b
;,,b c
if-- 
(-- 
!--  
skipConnVerification-- %
)--% &
{.. 
Log// 
.// 
Write// 
(// 
$str// c
)//c d
;//d e
var00 
command00 
=00 
Console00 %
.00% &
ReadLine00& .
(00. /
)00/ 0
;000 1
if11 
(11 
!11 
command11 
.11 
IsIn11 !
(11! "
$str11" %
,11% &
$str11' *
)11* +
)11+ ,
{22 
Log33 
.33 
Write33 
(33 
$str33 3
)333 4
;334 5
return44 
;44 
}55 
}66 
Log88 
.88 
Write88 
(88 
$str88 :
)88: ;
;88; <
try:: 
{;; 
	_migrator<< 
.<< "
CreateOrMigrateForHost<< 0
(<<0 1
)<<1 2
;<<2 3
}== 
catch>> 
(>> 
	Exception>> 
ex>> 
)>>  
{?? 
Log@@ 
.@@ 
Write@@ 
(@@ 
$str@@ O
)@@O P
;@@P Q
LogAA 
.AA 
WriteAA 
(AA 
exAA 
.AA 
ToStringAA %
(AA% &
)AA& '
)AA' (
;AA( )
LogBB 
.BB 
WriteBB 
(BB 
$strBB 0
)BB0 1
;BB1 2
returnCC 
;CC 
}DD 
LogFF 
.FF 
WriteFF 
(FF 
$strFF :
)FF: ;
;FF; <
LogGG 
.GG 
WriteGG 
(GG 
$strGG P
)GGP Q
;GGQ R
varII 
migratedDatabasesII !
=II" #
newII$ '
HashSetII( /
<II/ 0
stringII0 6
>II6 7
(II7 8
)II8 9
;II9 :
varJJ 
tenantsJJ 
=JJ 
_tenantRepositoryJJ +
.JJ+ ,

GetAllListJJ, 6
(JJ6 7
tJJ7 8
=>JJ9 ;
tJJ< =
.JJ= >
ConnectionStringJJ> N
!=JJO Q
nullJJR V
&&JJW Y
tJJZ [
.JJ[ \
ConnectionStringJJ\ l
!=JJm o
$strJJp r
)JJr s
;JJs t
forKK 
(KK 
intKK 
iKK 
=KK 
$numKK 
;KK 
iKK 
<KK 
tenantsKK  '
.KK' (
CountKK( -
;KK- .
iKK/ 0
++KK0 2
)KK2 3
{LL 
varMM 
tenantMM 
=MM 
tenantsMM $
[MM$ %
iMM% &
]MM& '
;MM' (
LogNN 
.NN 
WriteNN 
(NN 
stringNN  
.NN  !
FormatNN! '
(NN' (
$strNN( Z
,NNZ [
(NN\ ]
iNN] ^
+NN_ `
$numNNa b
)NNb c
,NNc d
tenantsNNe l
.NNl m
CountNNm r
)NNr s
)NNs t
;NNt u
LogOO 
.OO 
WriteOO 
(OO 
$strOO 0
+OO1 2
tenantOO3 9
.OO9 :
NameOO: >
)OO> ?
;OO? @
LogPP 
.PP 
WritePP 
(PP 
$strPP 0
+PP1 2
tenantPP3 9
.PP9 :
TenancyNamePP: E
)PPE F
;PPF G
LogQQ 
.QQ 
WriteQQ 
(QQ 
$strQQ 0
+QQ1 2
tenantQQ3 9
.QQ9 :
IdQQ: <
)QQ< =
;QQ= >
LogRR 
.RR 
WriteRR 
(RR 
$strRR 0
+RR1 2
SimpleStringCipherRR3 E
.RRE F
InstanceRRF N
.RRN O
DecryptRRO V
(RRV W
tenantRRW ]
.RR] ^
ConnectionStringRR^ n
)RRn o
)RRo p
;RRp q
ifTT 
(TT 
!TT 
migratedDatabasesTT &
.TT& '
ContainsTT' /
(TT/ 0
tenantTT0 6
.TT6 7
ConnectionStringTT7 G
)TTG H
)TTH I
{UU 
tryVV 
{WW 
	_migratorXX !
.XX! "$
CreateOrMigrateForTenantXX" :
(XX: ;
tenantXX; A
)XXA B
;XXB C
}YY 
catchZZ 
(ZZ 
	ExceptionZZ $
exZZ% '
)ZZ' (
{[[ 
Log\\ 
.\\ 
Write\\ !
(\\! "
$str\\" Y
)\\Y Z
;\\Z [
Log]] 
.]] 
Write]] !
(]]! "
ex]]" $
.]]$ %
ToString]]% -
(]]- .
)]]. /
)]]/ 0
;]]0 1
Log^^ 
.^^ 
Write^^ !
(^^! "
$str^^" W
)^^W X
;^^X Y
}__ 
migratedDatabasesaa %
.aa% &
Addaa& )
(aa) *
tenantaa* 0
.aa0 1
ConnectionStringaa1 A
)aaA B
;aaB C
}bb 
elsecc 
{dd 
Logee 
.ee 
Writeee 
(ee 
$str	ee ã
)
eeã å
;
eeå ç
}ff 
Loghh 
.hh 
Writehh 
(hh 
stringhh  
.hh  !
Formathh! '
(hh' (
$strhh( Z
,hhZ [
(hh\ ]
ihh] ^
+hh_ `
$numhha b
)hhb c
,hhc d
tenantshhe l
.hhl m
Counthhm r
)hhr s
)hhs t
;hht u
Logii 
.ii 
Writeii 
(ii 
$strii T
)iiT U
;iiU V
}jj 
Logll 
.ll 
Writell 
(ll 
$strll 9
)ll9 :
;ll: ;
}mm 	
}nn 
}oo ˛
SC:\Users\SWDEV\Source\Repos\SW10.SWMANAGER\Tools\SW10.SWMANAGER.Migrator\Program.cs
	namespace 	
SW10
 
. 
	SWMANAGER 
. 
Migrator !
{		 
public

 

class

 
Program

 
{ 
private 
static 
bool !
_skipConnVerification 1
=2 3
false4 9
;9 :
public 
static 
void 
Main 
(  
string  &
[& '
]' (
args) -
)- .
{ 	
	ParseArgs 
( 
args 
) 
; 
using 
( 
var 
bootstrapper #
=$ %
AbpBootstrapper& 5
.5 6
Create6 <
<< =#
SWMANAGERMigratorModule= T
>T U
(U V
)V W
)W X
{ 
bootstrapper 
. 

IocManager '
.' (
IocContainer( 4
. 
AddFacility  
<  !
LoggingFacility! 0
>0 1
(1 2
f2 3
=>4 6
f7 8
.8 9
UseAbpLog4Net9 F
(F G
)G H
. 

WithConfig #
(# $
$str$ 4
)4 5
) 
; 
bootstrapper 
. 

Initialize '
(' (
)( )
;) *
using 
( 
var 
migrateExecuter *
=+ ,
bootstrapper- 9
.9 :

IocManager: D
.D E
ResolveAsDisposableE X
<X Y&
MultiTenantMigrateExecuterY s
>s t
(t u
)u v
)v w
{ 
migrateExecuter #
.# $
Object$ *
.* +
Run+ .
(. /!
_skipConnVerification/ D
)D E
;E F
} 
Console   
.   
	WriteLine   !
(  ! "
$str  " :
)  : ;
;  ; <
Console!! 
.!! 
ReadLine!!  
(!!  !
)!!! "
;!!" #
}"" 
}## 	
private%% 
static%% 
void%% 
	ParseArgs%% %
(%%% &
string%%& ,
[%%, -
]%%- .
args%%/ 3
)%%3 4
{&& 	
if'' 
('' 
args'' 
.'' 
IsNullOrEmpty'' "
(''" #
)''# $
)''$ %
{(( 
return)) 
;)) 
}** 
for,, 
(,, 
int,, 
i,, 
=,, 
$num,, 
;,, 
i,, 
<,, 
args,,  $
.,,$ %
Length,,% +
;,,+ ,
i,,- .
++,,. 0
),,0 1
{-- 
var.. 
arg.. 
=.. 
args.. 
[.. 
i..  
]..  !
;..! "
switch// 
(// 
arg// 
)// 
{00 
case11 
$str11 
:11 !
_skipConnVerification22 -
=22. /
true220 4
;224 5
break33 
;33 
}44 
}55 
}66 	
}77 
}88 ˇ
cC:\Users\SWDEV\Source\Repos\SW10.SWMANAGER\Tools\SW10.SWMANAGER.Migrator\Properties\AssemblyInfo.cs
[		 
assembly		 	
:			 

AssemblyTitle		 
(		 
$str		 -
)		- .
]		. /
[

 
assembly

 	
:

	 

AssemblyDescription

 
(

 
$str

 !
)

! "
]

" #
[ 
assembly 	
:	 
!
AssemblyConfiguration  
(  !
$str! #
)# $
]$ %
[ 
assembly 	
:	 

AssemblyCompany 
( 
$str 
) 
] 
[ 
assembly 	
:	 

AssemblyProduct 
( 
$str /
)/ 0
]0 1
[ 
assembly 	
:	 

AssemblyCopyright 
( 
$str 0
)0 1
]1 2
[ 
assembly 	
:	 

AssemblyTrademark 
( 
$str 
)  
]  !
[ 
assembly 	
:	 

AssemblyCulture 
( 
$str 
) 
] 
[ 
assembly 	
:	 

InternalsVisibleTo 
( 
$str 8
)8 9
]9 :
[ 
assembly 	
:	 


ComVisible 
( 
false 
) 
] 
[ 
assembly 	
:	 

Guid 
( 
$str 6
)6 7
]7 8
[%% 
assembly%% 	
:%%	 

AssemblyVersion%% 
(%% 
AppVersionHelper%% +
.%%+ ,
Version%%, 3
)%%3 4
]%%4 5
[&& 
assembly&& 	
:&&	 

AssemblyFileVersion&& 
(&& 
AppVersionHelper&& /
.&&/ 0
Version&&0 7
)&&7 8
]&&8 9